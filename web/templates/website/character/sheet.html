{% extends "website/base_custom.html" %}
{% load static %}

{% block titleblock %}Character Sheet - {{ character.name }}{% endblock %}

{% block header_ext %}
<link rel="icon" type="image/png" href="{% static 'wiki/imgs/favicon.png' %}">
<style>
    /* Import fonts */
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap');
    @font-face {
        font-family: 'impact_label_reversed';
        src: local('Impact Label Reversed'),
             url('/static/wiki/fonts/impact_label_reversed.woff2') format('woff2');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
    }
    @font-face {
        font-family: 'punktype';
        src: url('/static/wiki/fonts/punktype.woff2') format('woff2');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
    }

    /* Navigation styles */
    .main-nav {
        position: fixed;
        z-index: 10000;
        top: 0;
        left: 0;
        width: 100%;
        height: 90px;
        color: #fff;
        transition: background-color 0.5s ease;
        background-color: rgba(0, 0, 0, 0.95);
        display: flex;
        justify-content: center;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .nav-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        max-width: 1728px;
        margin: 0 40px;
    }

    .nav-logo {
        font-family: 'punktype', Arial, sans-serif;
        font-size: 28px;
        letter-spacing: 5px;
        font-weight: normal;
        color: #fff;
        text-decoration: none;
    }

    .nav-menu {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .nav-menu a {
        font-family: 'impact_label_reversed', Arial, sans-serif;
        font-size: 20px;
        letter-spacing: 5px;
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        transition: color 0.3s ease;
        padding: 10px;
    }

    .nav-menu a:hover {
        color: rgba(255, 255, 255, 1);
    }

    .nav-menu .active a {
        color: rgba(255, 255, 255, 1);
        text-decoration: underline;
    }

    .nav-right {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .nav-search {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .nav-search form {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .nav-search input {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #fff;
        padding: 5px 10px;
        font-family: 'roboto mono', monospace;
        font-size: 14px;
        width: 200px;
    }

    .nav-search button {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #fff;
        padding: 5px 10px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .nav-search button:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    /* Existing styles */
    body {
        background-color: #000;
        color: #fff;
        margin: 0;
        padding: 0;
    }

    .container {
        max-width: 1728px;
        margin: 0 auto;
        padding: 0 40px;
    }

    .sheet-section {
        background: rgba(0, 0, 0, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .character-header {
        margin-top: 90px;
        padding: 20px 0;
    }

    .character-header h1 {
        font-family: 'impact_label_reversed', Arial, sans-serif;
        font-size: 48px;
        letter-spacing: 5px;
        margin: 0;
        color: #fff;
    }

    .character-header .splat {
        font-family: 'punktype', Arial, sans-serif;
        font-size: 24px;
        letter-spacing: 3px;
        color: rgba(255, 255, 255, 0.7);
    }

    .alert-warning {
        background: rgba(255, 193, 7, 0.1);
        border: 1px solid rgba(255, 193, 7, 0.3);
        color: rgba(255, 193, 7, 0.9);
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
        font-family: 'roboto mono', monospace;
    }

    .alert-staff {
        background: rgba(65, 105, 225, 0.1);
        border: 1px solid rgba(65, 105, 225, 0.3);
        color: rgba(65, 105, 225, 0.9);
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
        font-family: 'roboto mono', monospace;
    }

    .character-content {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 20px;
        margin-bottom: 40px;
    }

    .character-main {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .character-image {
        width: 100%;
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .sheet-header {
        font-family: 'impact_label_reversed', Arial, sans-serif;
        font-size: 24px;
        letter-spacing: 5px;
        color: #fff;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .editable-field {
        position: relative;
        margin-bottom: 20px;
    }

    .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-family: 'roboto mono', monospace;
    }

    .stat-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 14px;
    }

    .view-content {
        font-family: 'roboto mono', monospace;
        font-size: 14px;
        line-height: 1.6;
        color: rgba(255, 255, 255, 0.9);
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 4px;
        min-height: 20px;
    }

    .empty-content {
        color: rgba(255, 255, 255, 0.3);
        font-style: italic;
    }

    .edit-button {
        position: absolute;
        top: -52px;
        right: -15px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: rgba(255, 255, 255, 0.7);
        padding: 5px 10px;
        font-family: 'impact_label_reversed', Arial, sans-serif;
        font-size: 12px;
        letter-spacing: 2px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .edit-button:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
    }

    .edit-form textarea,
    .edit-form input {
        width: 100%;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #fff;
        padding: 10px;
        font-family: 'roboto mono', monospace;
        font-size: 14px;
        margin-bottom: 10px;
    }

    .edit-form button {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: rgba(255, 255, 255, 0.9);
        padding: 5px 15px;
        margin-right: 10px;
        cursor: pointer;
        font-family: 'impact_label_reversed', Arial, sans-serif;
        letter-spacing: 2px;
        font-size: 12px;
    }

    .edit-form button:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
    }

    @media (max-width: 1024px) {
        .character-content {
            grid-template-columns: 1fr;
        }

        .character-main {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .container {
            padding: 0 20px;
        }
    }

    /* Update hamburger menu styles */
    .hamburger-menu {
        display: none;
        cursor: pointer;
        z-index: 10003;
        padding: 15px;
        background: transparent;
        border: none;
        -webkit-tap-highlight-color: transparent;
    }

    .hamburger-icon {
        width: 30px;
        height: 30px;
        filter: invert(1);
        display: block;
        pointer-events: none;
    }

    .sliding-menu {
        position: fixed;
        top: 0;
        right: -100%;
        width: 100%;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.95);
        z-index: 10001;
        transition: transform 0.3s ease-out;
        transform: translateX(100%);
        padding-top: 90px;
        visibility: visible;
        display: none;
    }

    .sliding-menu.open {
        transform: translateX(0);
        right: 0;
        display: block;
    }

    .menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease-out;
        display: none;
    }

    .menu-overlay.open {
        opacity: 1;
        visibility: visible;
        display: block;
    }

    .menu-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: rgba(255, 255, 255, 0.9);
        padding: 10px 15px;
        cursor: pointer;
        font-family: 'impact_label_reversed', Arial, sans-serif;
        font-size: 14px;
        letter-spacing: 2px;
        transition: all 0.3s ease;
        z-index: 10002;
    }

    .menu-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
    }

    @media (max-width: 1530px) {
        .hamburger-menu {
            display: block;
        }

        .nav-menu {
            display: none;
        }

        .nav-search {
            display: none;
        }

        .nav-right {
            margin-left: auto;
        }

        .nav-wrapper {
            margin: 0 20px;
        }

        .sliding-menu {
            display: block;
        }

        .sliding-menu .menu-items {
            height: calc(100vh - 90px);
            overflow-y: auto;
            padding: 20px 40px;
        }

        .sliding-menu .menu-items ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sliding-menu .menu-items li {
            margin: 20px 0;
        }

        .sliding-menu .menu-items a {
            font-family: 'impact_label_reversed', Arial, sans-serif;
            font-size: 24px;
            letter-spacing: 5px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .sliding-menu .menu-items a:hover {
            color: rgba(255, 255, 255, 1);
        }
    }

    .no-image-placeholder {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        padding: 40px;
        text-align: center;
        margin-bottom: 20px;
    }

    .file-input-wrapper {
        position: relative;
        margin-bottom: 10px;
    }

    .file-input-wrapper input[type="file"] {
        position: absolute;
        left: -9999px;
    }

    .file-input-label {
        display: inline-block;
        padding: 10px 20px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: rgba(255, 255, 255, 0.9);
        cursor: pointer;
        font-family: 'impact_label_reversed', Arial, sans-serif;
        font-size: 14px;
        letter-spacing: 2px;
        transition: all 0.3s ease;
    }

    .file-input-label:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
    }

    .upload-button {
        display: inline-block;
        padding: 10px 20px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: rgba(255, 255, 255, 0.9);
        cursor: pointer;
        font-family: 'impact_label_reversed', Arial, sans-serif;
        font-size: 14px;
        letter-spacing: 2px;
        transition: all 0.3s ease;
    }

    .upload-button:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
    }

    .image-controls {
        margin-top: 20px;
    }

    .upload-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
    }

    .gallery-section {
        margin-top: 20px;
    }

    .image-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .gallery-item {
        position: relative;
        aspect-ratio: 1;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
    }

    .gallery-item.primary {
        border-color: rgba(255, 215, 0, 0.5);
    }

    .gallery-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .gallery-item:hover .gallery-image {
        transform: scale(1.05);
    }

    .gallery-controls {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        display: flex;
        gap: 10px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .gallery-item:hover .gallery-controls {
        opacity: 1;
    }

    .gallery-button {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: rgba(255, 255, 255, 0.9);
        padding: 5px 10px;
        font-family: 'impact_label_reversed', Arial, sans-serif;
        font-size: 12px;
        letter-spacing: 1px;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
    }

    .gallery-button:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
    }

    .gallery-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .gallery-button.make-primary {
        color: rgba(255, 215, 0, 0.9);
        border-color: rgba(255, 215, 0, 0.3);
    }

    .gallery-button.make-primary:hover {
        background: rgba(255, 215, 0, 0.1);
    }

    .gallery-button.delete-image {
        color: rgba(255, 99, 71, 0.9);
        border-color: rgba(255, 99, 71, 0.3);
    }

    .gallery-button.delete-image:hover {
        background: rgba(255, 99, 71, 0.1);
    }

    .add-image {
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }

    .add-image .file-input-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        cursor: pointer;
        color: rgba(255, 255, 255, 0.5);
        transition: all 0.3s ease;
    }

    .add-image .file-input-label:hover {
        color: rgba(255, 255, 255, 0.9);
        background: rgba(255, 255, 255, 0.05);
    }

    .add-image .file-input-label i {
        font-size: 24px;
        margin-bottom: 10px;
    }

    /* Lightbox styles */
    .lightbox {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10004;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .lightbox.active {
        display: flex;
        opacity: 1;
    }

    .lightbox-image {
        max-width: 90%;
        max-height: 90vh;
        object-fit: contain;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        transform: scale(0.9);
        transition: transform 0.3s ease;
    }

    .lightbox.active .lightbox-image {
        transform: scale(1);
    }

    .lightbox-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: rgba(255, 255, 255, 0.9);
        padding: 10px 15px;
        cursor: pointer;
        font-family: 'impact_label_reversed', Arial, sans-serif;
        font-size: 14px;
        letter-spacing: 2px;
        transition: all 0.3s ease;
    }

    .lightbox-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
    }
</style>
{% endblock %}

{% block navigation %}
<nav class="main-nav">
    <div class="nav-wrapper">
        <a href="/" class="nav-logo">Dies Irae</a>
        <div class="nav-menu">
            <a href="/" {% if request.path == '/' %}class="active"{% endif %}>HOME</a>
            <a href="/characters/" {% if '/characters/' in request.path %}class="active"{% endif %}>CHARACTERS</a>
            <a href="/wiki/" {% if '/wiki/' in request.path %}class="active"{% endif %}>WIKI</a>
            <a href="/channels/" {% if '/channels/' in request.path %}class="active"{% endif %}>CHANNELS</a>
            <a href="/help/" {% if '/help/' in request.path %}class="active"{% endif %}>HELP</a>
            <a href="/play/" {% if '/play/' in request.path %}class="active"{% endif %}>PLAY ONLINE</a>
        </div>
        <div class="nav-right">
            <div class="nav-search">
                <form action="{% url 'wiki:search' %}" method="get">
                    <input type="text" name="q" placeholder="Search wiki...">
                    <button type="submit"><i class="fas fa-search"></i></button>
                </form>
            </div>
            <button class="hamburger-menu">
                <img src="/static/wiki/imgs/hamburger.svg" alt="Menu" class="hamburger-icon">
            </button>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<!-- Remove hamburger button from here since it's now in the nav -->
<div class="sliding-menu">
    <button class="menu-close">CLOSE</button>
    <div class="menu-items">
        <ul>
            <li><a href="/">HOME</a></li>
            <li><a href="/characters/">CHARACTERS</a></li>
            <li><a href="/wiki/">WIKI</a></li>
            <li><a href="/channels/">CHANNELS</a></li>
            <li><a href="/help/">HELP</a></li>
            <li><a href="/webclient/">PLAY ONLINE</a></li>
        </ul>
    </div>
</div>
<div class="menu-overlay"></div>

<div class="container">
    <div class="character-header">
        <h1>{{ character.name }}</h1>
       
        {% if is_staff %}
            <div class="alert alert-staff">
                This is a Staff member.
            </div>
        {% elif is_storyteller %}
            <div class="alert alert-storyteller">
                This is a Player Storyteller character.
            </div>
        {% elif not approved %}
            <div class="alert alert-warning">
                This character is not yet approved.
            </div>
        {% endif %}
    </div>

    <div class="character-content">
        <div class="sheet-section">
            <h3 class="sheet-header">Character Image</h3>
            {% if character.images.exists %}
                {% with primary_image=character.images.first %}
                    {% if primary_image.image %}
                        <img src="{{ primary_image.image.url }}" alt="{{ character.name }}" class="character-image">
                    {% else %}
                        <div class="no-image-placeholder">
                            <p>Image not found</p>
                        </div>
                    {% endif %}
                {% endwith %}
                {% if can_edit %}
                    <div class="image-controls">
                        <form action="{% url 'character-upload-image' character.key character.id %}" method="post" enctype="multipart/form-data" class="upload-form" id="image-upload-form">
                            {% csrf_token %}
                            <div class="file-input-wrapper">
                                <input type="file" name="image" accept="image/*" id="image-upload" required>
                                <label for="image-upload" class="file-input-label">
                                    <i class="fas fa-upload"></i> Choose New Image
                                </label>
                            </div>
                            <button type="submit" class="upload-button">
                                <i class="fas fa-save"></i> Upload
                            </button>
                        </form>
                    </div>
                {% endif %}
            {% else %}
                {% if can_edit %}
                    <div class="no-image-placeholder">
                        <form action="{% url 'character-upload-image' character.key character.id %}" method="post" enctype="multipart/form-data" class="upload-form">
                            {% csrf_token %}
                            <div class="file-input-wrapper">
                                <input type="file" name="image" accept="image/*" id="image-upload">
                                <label for="image-upload" class="file-input-label">
                                    <i class="fas fa-upload"></i> Choose Image
                                </label>
                            </div>
                            <button type="submit" class="upload-button">
                                <i class="fas fa-save"></i> Upload
                            </button>
                        </form>
                    </div>
                {% else %}
                    <div class="no-image-placeholder">
                        <p>No image uploaded</p>
                    </div>
                {% endif %}
            {% endif %}

            <h3 class="sheet-header">Vitals</h3>
            {% for field in vitals_fields %}
            <div class="editable-field">
                {% if can_edit %}
                <button class="edit-button">
                    <i class="fas fa-edit"></i> Edit
                </button>
                {% endif %}
                <div class="stat-row">
                    <span class="stat-label">{{ field.label }}</span>
                    <div class="view-content {% if not field.value %}empty-content{% endif %}" id="{{ field.id }}-content">
                        {% if field.value %}{{ field.value }}{% endif %}
                    </div>
                </div>
                {% if can_edit %}
                <div class="edit-form" id="{{ field.id }}-form">
                    <input type="text" value="{{ field.value }}" id="{{ field.id }}-input">
                    <div>
                        <button onclick="saveField('{{ field.id }}')">Save</button>
                        <button onclick="toggleEdit('{{ field.id }}')">Cancel</button>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <div class="character-main">
            <div class="sheet-section">
                <h3 class="sheet-header">Biography</h3>
                <div class="editable-field">
                    {% if can_edit %}
                    <button class="edit-button">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    {% endif %}
                    <div class="view-content {% if not biography %}empty-content{% endif %}" id="biography-content">
                        {{ biography_html|safe }}
                    </div>
                    {% if can_edit %}
                    <div class="edit-form" id="biography-form">
                        <textarea rows="6" id="biography-input">{{ biography }}</textarea>
                        <div>
                            <button onclick="saveField('biography')">Save</button>
                            <button onclick="toggleEdit('biography')">Cancel</button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="sheet-section">
                <h3 class="sheet-header">RP Hooks</h3>
                <div class="editable-field">
                    {% if can_edit %}
                    <button class="edit-button">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    {% endif %}
                    <div class="view-content {% if not rp_hooks %}empty-content{% endif %}" id="rp_hooks-content">
                        {{ rp_hooks_html|safe }}
                    </div>
                    {% if can_edit %}
                    <div class="edit-form" id="rp_hooks-form">
                        <textarea rows="4" id="rp_hooks-input">{{ rp_hooks }}</textarea>
                        <div>
                            <button onclick="saveField('rp_hooks')">Save</button>
                            <button onclick="toggleEdit('rp_hooks')">Cancel</button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="sheet-section">
                <h3 class="sheet-header">Notable Stats</h3>
                <div class="editable-field">
                    {% if can_edit %}
                    <button class="edit-button">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    {% endif %}
                    <div class="view-content {% if not notable_stats %}empty-content{% endif %}" id="notable_stats-content">
                        {{ notable_stats_html|safe }}
                    </div>
                    {% if can_edit %}
                    <div class="edit-form" id="notable_stats-form">
                        <textarea rows="4" id="notable_stats-input">{{ notable_stats }}</textarea>
                        <div>
                            <button onclick="saveField('notable_stats')">Save</button>
                            <button onclick="toggleEdit('notable_stats')">Cancel</button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="sheet-section">
                <h3 class="sheet-header">Soundtrack</h3>
                <div class="editable-field">
                    {% if can_edit %}
                    <button class="edit-button">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    {% endif %}
                    <div class="view-content {% if not soundtrack %}empty-content{% endif %}" id="soundtrack-content">
                        {{ soundtrack_html|safe }}
                    </div>
                    {% if can_edit %}
                    <div class="edit-form" id="soundtrack-form">
                        <textarea rows="4" id="soundtrack-input">{{ soundtrack }}</textarea>
                        <div>
                            <button onclick="saveField('soundtrack')">Save</button>
                            <button onclick="toggleEdit('soundtrack')">Cancel</button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if character_images.exists %}
    <div class="sheet-section gallery-section">
        <h3 class="sheet-header">Image Gallery</h3>
        <div class="image-gallery">
            {% for image in character_images %}
            <div class="gallery-item {% if image.is_primary %}primary{% endif %}" data-image-id="{{ image.id }}">
                <img src="{{ image.image.url }}" alt="{{ character.name }} - Image {{ forloop.counter }}" class="gallery-image" onclick="openLightbox('{{ image.image.url }}')">
                {% if can_edit %}
                <div class="gallery-controls">
                    <button class="gallery-button make-primary" data-image-id="{{ image.id }}" {% if image.is_primary %}disabled{% endif %} onclick="setPrimaryImage('{{ character.key }}', '{{ character.id }}', '{{ image.id }}')">
                        <i class="fas fa-star"></i> Make Primary
                    </button>
                    <button class="gallery-button delete-image" data-image-id="{{ image.id }}" onclick="deleteImage('{{ character.key }}', '{{ character.id }}', '{{ image.id }}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
                {% endif %}
            </div>
            {% endfor %}
            {% if can_edit and character_images.count < 5 %}
            <div class="gallery-item add-image">
                <form action="{% url 'character-upload-image' character.key character.id %}" method="post" enctype="multipart/form-data" class="upload-form">
                    {% csrf_token %}
                    <div class="file-input-wrapper">
                        <input type="file" name="image" accept="image/*" id="gallery-image-upload">
                        <label for="gallery-image-upload" class="file-input-label">
                            <i class="fas fa-plus"></i><br>
                            Add Image
                        </label>
                    </div>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Lightbox Modal -->
    <div class="lightbox" id="imageLightbox" onclick="closeLightbox()">
        <button class="lightbox-close">CLOSE</button>
        <img class="lightbox-image" src="" alt="Expanded view">
    </div>
</div>

{% if can_edit %}
<script>
const key = "{{ character.key }}";
const dbref = "{{ character.id }}";

// Add click handlers to all editable fields
document.addEventListener('DOMContentLoaded', function() {
    const editableFields = document.querySelectorAll('.editable-field');
    editableFields.forEach(field => {
        const button = field.querySelector('.edit-button');
        const content = field.querySelector('.view-content');
        if (button && content) {
            // Make both the button and content area clickable
            [button, content].forEach(el => {
                el.addEventListener('click', () => {
                    const fieldId = field.querySelector('.edit-form').id.replace('-form', '');
                    toggleEdit(fieldId);
                });
            });
        }
    });
});

function toggleEdit(field) {
    const form = document.getElementById(`${field}-form`);
    const content = document.getElementById(`${field}-content`);
    form.classList.toggle('active');
    if (form.classList.contains('active')) {
        const input = form.querySelector('textarea, input');
        input.focus();
    }
}

function saveField(field) {
    const value = document.getElementById(`${field}-input`).value;
    const content = document.getElementById(`${field}-content`);
    
    fetch(`/characters/update/${key}/${dbref}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `field=${field}&value=${encodeURIComponent(value)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (field === 'image_url') {
                location.reload();
            } else {
                content.innerHTML = value.replace(/\n/g, '<br>');
                content.classList.toggle('empty-content', !value);
                toggleEdit(field);
            }
        } else {
            alert('Error saving changes');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving changes');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const hamburger = document.querySelector('.hamburger-menu');
    const slidingMenu = document.querySelector('.sliding-menu');
    const menuOverlay = document.querySelector('.menu-overlay');
    const menuClose = document.querySelector('.menu-close');

    function toggleMenu(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        const isCurrentlyOpen = slidingMenu.classList.contains('open');

        if (!isCurrentlyOpen) {
            slidingMenu.style.display = 'block';
            menuOverlay.style.display = 'block';
            slidingMenu.offsetHeight;
            menuOverlay.offsetHeight;
            
            slidingMenu.classList.add('open');
            menuOverlay.classList.add('open');
            document.body.style.overflow = 'hidden';
        } else {
            slidingMenu.classList.remove('open');
            menuOverlay.classList.remove('open');
            document.body.style.overflow = '';
            
            setTimeout(() => {
                if (!slidingMenu.classList.contains('open')) {
                    slidingMenu.style.display = 'none';
                    menuOverlay.style.display = 'none';
                }
            }, 300);
        }
    }

    if (hamburger) {
        const newHamburger = hamburger.cloneNode(true);
        hamburger.parentNode.replaceChild(newHamburger, hamburger);
        
        newHamburger.addEventListener('click', toggleMenu, { passive: false });
        newHamburger.addEventListener('touchend', function(e) {
            e.preventDefault();
            toggleMenu(e);
        }, { passive: false });
    }

    if (menuClose) {
        menuClose.addEventListener('click', toggleMenu);
        menuClose.addEventListener('touchend', toggleMenu);
    }

    if (menuOverlay) {
        menuOverlay.addEventListener('click', toggleMenu);
        menuOverlay.addEventListener('touchend', toggleMenu);
    }
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('image-upload');
        const fileLabel = document.querySelector('.file-input-label');
        const uploadForm = document.getElementById('image-upload-form');
        
        if (fileInput) {
            fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const fileName = this.files[0].name;
                    fileLabel.innerHTML = `<i class="fas fa-check"></i> ${fileName}`;
                }
            });
        }
    
        if (uploadForm) {
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                
                // Disable form elements during upload
                const submitButton = this.querySelector('button[type="submit"]');
                const fileInput = this.querySelector('input[type="file"]');
                submitButton.disabled = true;
                fileInput.disabled = true;
                
                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);  // Add logging to verify response
                    if (data && data.success) {
                        window.location.reload();
                    } else {
                        throw new Error(data.error || 'Failed to upload image');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message || 'Error uploading image');
                    
                    // Re-enable form elements
                    submitButton.disabled = false;
                    fileInput.disabled = false;
                });
            });
        }
    });
    </script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gallery image upload handling
    const galleryFileInput = document.getElementById('gallery-image-upload');
    if (galleryFileInput) {
        galleryFileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                this.closest('form').submit();
            }
        });
    }

    // Make primary button handling
    document.querySelectorAll('.make-primary').forEach(button => {
        button.addEventListener('click', function() {
            const imageId = this.dataset.imageId;
            setPrimaryImage(key, dbref, imageId);
        });
    });

    // Delete image button handling
    document.querySelectorAll('.delete-image').forEach(button => {
        button.addEventListener('click', function() {
            const imageId = this.dataset.imageId;
            deleteImage(key, dbref, imageId);
        });
    });
});

function setPrimaryImage(key, dbref, imageId) {
    fetch(`/characters/set-primary-image/${key}/${dbref}/${imageId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // First, remove primary status from all images
            document.querySelectorAll('.gallery-item').forEach(item => {
                item.classList.remove('primary');
                const button = item.querySelector('.make-primary');
                if (button) {
                    button.disabled = false;
                }
            });
            
            // Fix: Update selector to find the correct gallery item
            const newPrimaryItem = document.querySelector(`.gallery-item[data-image-id="${imageId}"]`);
            if (newPrimaryItem) {
                newPrimaryItem.classList.add('primary');
                const button = newPrimaryItem.querySelector('.make-primary');
                if (button) {
                    button.disabled = true;
                }
            }
            
            // Update main image
            const mainImage = document.querySelector('.character-image');
            const newPrimaryImage = document.querySelector(`.gallery-item[data-image-id="${imageId}"] img`);
            if (mainImage && newPrimaryImage) {
                mainImage.src = newPrimaryImage.src;
            }
        } else {
            alert(data.error || 'Failed to set primary image');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error setting primary image');
    });
}

function deleteImage(key, dbref, imageId) {
    if (confirm('Are you sure you want to delete this image?')) {
        fetch(`/characters/delete-image/${key}/${dbref}/${imageId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Reload to update gallery and main image
            } else {
                alert(data.error || 'Failed to delete image');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting image');
        });
    }
}
</script>

<script>
// Lightbox functionality
function openLightbox(imageUrl) {
    const lightbox = document.getElementById('imageLightbox');
    const lightboxImage = lightbox.querySelector('.lightbox-image');
    lightboxImage.src = imageUrl;
    
    // Force reflow before adding active class for animation
    lightbox.style.display = 'flex';
    lightbox.offsetHeight;
    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeLightbox() {
    const lightbox = document.getElementById('imageLightbox');
    lightbox.classList.remove('active');
    document.body.style.overflow = '';
    
    // Wait for animation to finish before hiding
    setTimeout(() => {
        if (!lightbox.classList.contains('active')) {
            lightbox.style.display = 'none';
        }
    }, 300);
}

// Close lightbox with escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeLightbox();
    }
});
</script>
{% endblock %} 